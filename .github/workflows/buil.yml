name: üêç Python to EXE Builder

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    # 1. –ó–∞–±—Ä–∞—Ç—å –∫–æ–¥
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # 2. üîç –ù–∞–π—Ç–∏ –í–°–ï Python —Ñ–∞–π–ª—ã
    - name: üîç Find Python files
      id: find-files
      run: |
        echo "=== –ü–æ–∏—Å–∫ Python —Ñ–∞–π–ª–æ–≤ ==="
        
        # –ò—â–µ–º –≤—Å–µ .py —Ñ–∞–π–ª—ã (–∫—Ä–æ–º–µ —Ç–µ—Å—Ç–æ–≤)
        $files = Get-ChildItem -Recurse -Filter *.py | 
                  Where-Object { 
                    $_.Name -notmatch 'test' -and 
                    $_.FullName -notmatch 'venv|env|\.git' 
                  }
        
        if ($files.Count -eq 0) {
          echo "‚ùå Python —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!"
          exit 1
        }
        
        echo "‚úÖ –ù–∞–π–¥–µ–Ω–æ $($files.Count) Python —Ñ–∞–π–ª–æ–≤:"
        $files | ForEach-Object { 
          echo "  - $($_.Name) (–≤ $($_.Directory.Name))" 
        }
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–æ–≤
        $fileList = $files | ForEach-Object { $_.FullName } | ConvertTo-Json
        echo "fileList=$fileList" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª
        $mainFiles = @('main.py', 'app.py', 'run.py', 'manager.py', 'server.py', 'start.py')
        
        foreach ($name in $mainFiles) {
          $file = Get-Item $name -ErrorAction SilentlyContinue
          if ($file) {
            echo "mainFile=$($file.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            echo "‚úÖ –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª –æ–ø—Ä–µ–¥–µ–ª–µ–Ω: $name"
            break
          }
        }
        
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∏–º–µ–Ω–∞, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π .py —Ñ–∞–π–ª
        if (-not (Test-Path 'env:GITHUB_OUTPUT')) {
          $first = $files[0].FullName
          echo "mainFile=$first" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          echo "‚ö†Ô∏è  –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π —Ñ–∞–π–ª: $($files[0].Name)"
        }
    
    # 3. üêç –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Python
    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    # 4. üì¶ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å PyInstaller
    - name: üì¶ Install PyInstaller
      run: |
        pip install --upgrade pip
        pip install pyinstaller
        
        # –ü—Ä–æ–±—É–µ–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        if (Test-Path "requirements.txt") {
          echo "üìã –ù–∞–π–¥–µ–Ω requirements.txt, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
          pip install -r requirements.txt
        } else {
          echo "üìã requirements.txt –Ω–µ –Ω–∞–π–¥–µ–Ω, —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
        }
    
    # 5. üî® –°–æ–±—Ä–∞—Ç—å EXE –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    - name: üî® Build EXE
      id: build-exe
      run: |
        $mainFile = "${{ steps.find-files.outputs.mainFile }}"
        
        if (-not $mainFile) {
          # –†–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç: –∏—â–µ–º –≤—Ä—É—á–Ω—É—é
          $mainFile = Get-ChildItem -Recurse -Filter *.py | 
                      Where-Object { $_.Name -notmatch 'test' } | 
                      Select-Object -First 1 -ExpandProperty FullName
        }
        
        echo "üì¶ –°–±–æ—Ä–∫–∞ EXE –∏–∑: $mainFile"
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–º—è –¥–ª—è EXE (–±–µ–∑ .py)
        $exeName = [System.IO.Path]::GetFileNameWithoutExtension($mainFile)
        
        # –°–æ–±–∏—Ä–∞–µ–º EXE
        pyinstaller `
          --onefile `
          --console `
          --name "$exeName" `
          --clean `
          $mainFile
        
        echo "exeName=$exeName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        echo "exePath=dist/$exeName.exe" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
    
    # 6. üìÅ –°–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω—ã–π –ø–∞–∫–µ—Ç (EXE + –≤—Å–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞)
    - name: üìÅ Create complete package
      run: |
        $exeName = "${{ steps.build-exe.outputs.exeName }}"
        
        # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è —Ä–µ–ª–∏–∑–∞
        New-Item -ItemType Directory -Path "release" -Force
        
        # –ö–æ–ø–∏—Ä—É–µ–º EXE
        Copy-Item "dist/$exeName.exe" -Destination "release/"
        
        # –ö–æ–ø–∏—Ä—É–µ–º –í–°–ï —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ (–∫—Ä–æ–º–µ —Å–ª—É–∂–µ–±–Ω—ã—Ö)
        Get-ChildItem -Path . -Recurse | 
          Where-Object { 
            $_.FullName -notmatch '\.git|__pycache__|dist|build|release|\.github' -and
            $_.Name -notmatch '\.pyc$'
          } |
          ForEach-Object {
            $relativePath = $_.FullName.Substring((Get-Location).Path.Length + 1)
            $destPath = Join-Path "release" $relativePath
            
            if ($_.PSIsContainer) {
              New-Item -ItemType Directory -Path $destPath -Force | Out-Null
            } else {
              $destDir = Split-Path $destPath -Parent
              if (-not (Test-Path $destDir)) {
                New-Item -ItemType Directory -Path $destDir -Force | Out-Null
              }
              Copy-Item $_.FullName -Destination $destPath -Force
            }
          }
        
        echo "üìÅ –°–æ–∑–¥–∞–Ω—ã —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ release/"
        Get-ChildItem "release/" -Recurse | Select-Object -First 20
    
    # 7. üì¶ –ó–∞–ø–∞–∫–æ–≤–∞—Ç—å –≤ ZIP
    - name: üì¶ Create ZIP archive
      run: |
        $exeName = "${{ steps.build-exe.outputs.exeName }}"
        $zipName = "$exeName-$(Get-Date -Format 'yyyyMMdd-HHmm').zip"
        
        # –°–æ–∑–¥–∞–µ–º ZIP –∞—Ä—Ö–∏–≤
        Compress-Archive -Path "release/*" -DestinationPath "$zipName" -Force
        
        echo "üì¶ –°–æ–∑–¥–∞–Ω –∞—Ä—Ö–∏–≤: $zipName"
        echo "zipName=$zipName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
    
    # 8. ‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
    - name: ‚¨ÜÔ∏è Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: üöÄ Application-Package
        path: |
          ${{ steps.build-exe.outputs.zipName }}
          dist/*.exe
          release/
        retention-days: 90
    
    # 9. üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–±–æ—Ä–∫–µ
    - name: üìä Build info
      run: |
        echo "========================================"
        echo "‚úÖ –°–ë–û–†–ö–ê –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–ê!"
        echo "========================================"
        echo ""
        echo "üìÅ –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª: ${{ steps.find-files.outputs.mainFile }}"
        echo "üöÄ EXE —Ñ–∞–π–ª: ${{ steps.build-exe.outputs.exePath }}"
        echo "üì¶ ZIP –∞—Ä—Ö–∏–≤: ${{ steps.build-exe.outputs.zipName }}"
        echo ""
        echo "üì• –ö–∞–∫ —Å–∫–∞—á–∞—Ç—å:"
        echo "1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫—É 'Actions'"
        echo "2. –í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç—É —Å–±–æ—Ä–∫—É"
        echo "3. –í–Ω–∏–∑—É –Ω–∞–π–¥–∏—Ç–µ 'Artifacts'"
        echo "4. –°–∫–∞—á–∞–π—Ç–µ 'Application-Package'"
        echo ""
        echo "üí° –°–æ–≤–µ—Ç: –ï—Å–ª–∏ EXE –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ"
        echo "–Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–ø–∫–µ release/"
        echo "========================================"
